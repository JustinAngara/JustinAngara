name: LOC card (C/C++/Java/JS/TS)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1" # weekly (Mon 09:00 UTC)

permissions:
  contents: write

jobs:
  loc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq git python3 cargo

      - name: Install tokei
        run: |
          cargo install tokei --locked
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          tokei --version

      - name: Scan repos and generate card
        env:
          GH_TOKEN: ${{ secrets.LOC_PAT }}
        run: |
          set -euo pipefail
          gh auth status

          rm -rf _repos
          mkdir -p _repos

          # list repos (skip forks + archived)
          gh repo list --limit 2000 --json nameWithOwner,isFork,isArchived \
            --jq '.[] | select(.isFork==false and .isArchived==false) | .nameWithOwner' \
            > _repos/repos.txt

          # clone + tokei json per repo
          while IFS= read -r repo; do
            echo "==> $repo"
            dir="_repos/$(echo "$repo" | tr '/' '__')"
            rm -rf "$dir"

            if ! gh repo clone "$repo" "$dir" -- --depth 1 >/dev/null 2>&1; then
              echo "   (skip) clone failed: $repo"
              continue
            fi

            tokei "$dir" \
              --exclude "$dir/.git" \
              --exclude "$dir/node_modules" \
              --exclude "$dir/dist" \
              --exclude "$dir/build" \
              --exclude "$dir/target" \
              --exclude "$dir/out" \
              --exclude "$dir/bin" \
              --exclude "$dir/obj" \
              --exclude "$dir/.next" \
              --exclude "$dir/.cache" \
              --exclude "$dir/vendor" \
              --exclude "$dir/third_party" \
              --exclude "$dir/.venv" \
              --exclude "$dir/venv" \
              --output json > "${dir}.tokei.json" || true
          done < _repos/repos.txt

          # combine + filter to only: C, C++, Java, JavaScript, TypeScript
          python3 - << 'PY'
          import json, glob, datetime

          # tokei language labels vary; map into your buckets
          def bucket(lang: str):
            if lang == "C": return "C"
            if lang in ("C Header",): return "C"
            if lang in ("C++", "C++ Header"): return "C++"
            if lang == "Java": return "Java"
            if lang == "JavaScript": return "JavaScript"
            if lang == "TypeScript": return "TypeScript"
            return None

          totals = {k: {"code":0,"comments":0,"blanks":0} for k in ["C","C++","Java","JavaScript","TypeScript"]}

          for fp in glob.glob("_repos/*.tokei.json"):
            try:
              data = json.load(open(fp, "r", encoding="utf-8"))
            except Exception:
              continue
            for lang, v in data.items():
              if lang == "Total":
                continue
              b = bucket(lang)
              if not b:
                continue
              totals[b]["code"] += int(v.get("code", 0))
              totals[b]["comments"] += int(v.get("comments", 0))
              totals[b]["blanks"] += int(v.get("blanks", 0))

          # compute grand totals
          grand = {"code":0,"comments":0,"blanks":0}
          for k in totals:
            for f in grand:
              grand[f] += totals[k][f]
          grand["lines"] = grand["code"] + grand["comments"] + grand["blanks"]

          # write machine-readable summary
          out = {
            "generated_utc": datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC"),
            "languages": totals,
            "grand": grand
          }
          with open("loc_summary.json", "w", encoding="utf-8") as f:
            json.dump(out, f, indent=2)

          # build a cleaner SVG card with purple theme
          def fmt(n): return f"{n:,}"

          # language color dots
          colors = {
            "C": "#555555",
            "C++": "#f34b7d",
            "Java": "#b07219",
            "JavaScript": "#f1e05a",
            "TypeScript": "#3178c6",
          }

          lines = [
            ("C", totals["C"], colors["C"]),
            ("C++", totals["C++"], colors["C++"]),
            ("Java", totals["Java"], colors["Java"]),
            ("JavaScript", totals["JavaScript"], colors["JavaScript"]),
            ("TypeScript", totals["TypeScript"], colors["TypeScript"]),
          ]

          # layout - compact card with only code and proportion
          w, h = 550, 280
          padding = 30
          row_h = 32
          start_y = 40

          svg = []
          svg.append(f'<svg xmlns="http://www.w3.org/2000/svg" width="{w}" height="{h}" viewBox="0 0 {w} {h}">')
          
          # gradient background
          svg.append('<defs>')
          svg.append('<linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">')
          svg.append('<stop offset="0%" style="stop-color:#2d2d44;stop-opacity:1" />')
          svg.append('<stop offset="100%" style="stop-color:#1a1a2e;stop-opacity:1" />')
          svg.append('</linearGradient>')
          svg.append('<filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">')
          svg.append('<feDropShadow dx="0" dy="4" stdDeviation="8" flood-opacity="0.3"/>')
          svg.append('</filter>')
          svg.append('</defs>')

          # card background
          svg.append(f'<rect width="{w}" height="{h}" fill="url(#grad)" rx="12"/>')
          svg.append(f'<rect x="1" y="1" width="{w-2}" height="{h-2}" rx="11" fill="none" stroke="#4a4a6a" stroke-width="1" opacity="0.3"/>')

          y = start_y

          # each language row
          for name, v, color in lines:
            total = v["code"] + v["comments"]
            if total == 0:
              continue
            
            # calculate proportion based on code only
            proportion = (v["code"] / grand["code"] * 100) if grand["code"] > 0 else 0
              
            # language dot + name
            svg.append(f'<circle cx="{padding+6}" cy="{y-4}" r="5" fill="{color}"/>')
            svg.append(f'<text x="{padding+20}" y="{y}" font-family="\'Segoe UI\', Roboto, -apple-system, sans-serif" '
                       f'font-size="15" fill="#e8e8f5" font-weight="500">{name}</text>')
            
            # code count
            svg.append(f'<text x="{w-padding-130}" y="{y}" font-family="\'Consolas\', \'Monaco\', monospace" '
                       f'font-size="15" fill="#a8a8c8" text-anchor="end">{fmt(v["code"])}</text>')
            
            # proportion
            svg.append(f'<text x="{w-padding}" y="{y}" font-family="\'Consolas\', \'Monaco\', monospace" '
                       f'font-size="15" fill="#9d9dbd" text-anchor="end">{proportion:.2f}%</text>')
            
            y += row_h

          # separator line
          y += 8
          svg.append(f'<line x1="{padding}" y1="{y}" x2="{w-padding}" y2="{y}" stroke="#4a4a6a" stroke-width="1.5" opacity="0.5"/>')
          y += 26

          # total row
          svg.append(f'<text x="{padding}" y="{y}" font-family="\'Segoe UI\', Roboto, -apple-system, sans-serif" '
                     f'font-size="16" fill="#f0f0ff" font-weight="700">TOTAL</text>')
          svg.append(f'<text x="{w-padding-130}" y="{y}" font-family="\'Consolas\', \'Monaco\', monospace" '
                     f'font-size="16" fill="#ffd700" text-anchor="end" font-weight="700">{fmt(grand["code"])}</text>')
          svg.append(f'<text x="{w-padding}" y="{y}" font-family="\'Consolas\', \'Monaco\', monospace" '
                     f'font-size="16" fill="#ffd700" text-anchor="end" font-weight="700">100.00%</text>')

          # column headers at top
          svg.append(f'<text x="{padding}" y="22" font-family="\'Segoe UI\', Roboto, -apple-system, sans-serif" '
                     f'font-size="11" fill="#8888aa" font-weight="600">LANGUAGE</text>')
          svg.append(f'<text x="{w-padding-130}" y="22" font-family="\'Segoe UI\', Roboto, -apple-system, sans-serif" '
                     f'font-size="11" fill="#8888aa" text-anchor="end" font-weight="600">CODE</text>')
          svg.append(f'<text x="{w-padding}" y="22" font-family="\'Segoe UI\', Roboto, -apple-system, sans-serif" '
                     f'font-size="11" fill="#8888aa" text-anchor="end" font-weight="600">PROPORTION</text>')

          svg.append("</svg>")

          with open("loc_card.svg", "w", encoding="utf-8") as f:
            f.write("\n".join(svg))
          PY

      - name: Commit card + summary
        run: |
          set -euo pipefail
          git config user.name "loc-bot"
          git config user.email "loc-bot@users.noreply.github.com"
          git add loc_card.svg loc_summary.json
          git commit -m "Update LOC card" || exit 0
          git push